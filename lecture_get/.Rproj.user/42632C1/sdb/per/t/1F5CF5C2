{
    "collab_server" : "",
    "contents" : "library(lubridate)\nlibrary(data.table)\nlibrary(dplyr)\nlibrary(zoo)\nlibrary(sandwich)\nlibrary(lmtest)\n\nsink(file=\"C:/Users/Ding/Desktop/result.txt\",append=T)\nsink()\nrm(list=ls())\n\n#################################\n#### Input the Monthly Stock Data\nda_all_m <- NULL # daily price for all securities\n# There something wrong for \"fread\" to read this data.\n# Everything is fine when using \"read.csv\".\nfor (i in 2007:2016) {   \n  path <- paste0(\"F:/我的论文/第三篇/RData/da_m/\",i,\".csv\")\n  da_all_m <- rbind(da_all_m,read.csv(path,header=T))\n}\nda_all_m <- da_all_m[,-ncol(da_all_m)]\nsave(da_all_m,file=\"C:/Users/Ding/Desktop/da_all_m.RData\")\n\n#################################\nload(\"D:/厦门大学研究生/量化投资（赵华）/作业/HW3/RData/da_all_m.RData\")\n\nda_all_m <- as.data.table(na.omit(da_all_m[,c(3,9,10,24,29,37,43)]))\nnames(da_all_m) <- c(\"SecCode\",\"TDate\",\"clpr\",\"trdshr\",\"ret\",\"rf\",\"PB\")\n# only include A stock\nda_all_m <- da_all_m[(SecCode>=600000 & SecCode<900000) | SecCode<200000,]\nda_all_m[,`:=`(ret_e = ret-rf,\n               size = clpr*trdshr,\n               BM = 1/PB,\n               TDate = ymd(TDate))]\nda_all_m[,`:=`(y = year(TDate),\n               m = month(TDate))]\nda_all_m[,ym := ymd(paste0(y,\"-\",m,\"-\",1))]\nsave(da_all_m,file=\"C:/Users/Ding/Desktop/da_all_m_a.RData\") \n# a denotes the adjusted version of the previous da_all_m.RData\n\n#################################\n#### Calculate FFC4F\nload(\"D:/厦门大学研究生/量化投资（赵华）/作业/HW3/RData/da_all_m_a.RData\")\n\nda_all_m[,group_size:=ifelse(size>median(size),\"b\",\"s\"),by=ym]\n\nda_all_m[BM<=quantile(BM,0.3),group_BM := \"l\",by=.(ym,group_size)]\nda_all_m[BM>quantile(BM,0.3) & BM<=quantile(BM,0.7),group_BM := \"m\",by=.(ym,group_size)]\nda_all_m[BM>quantile(BM,0.7),group_BM := \"h\",by=.(ym,group_size)]\n\n# Method 1 # filter stocks having more than 13 observations \nselectedcode <- da_all_m[,.N,by=SecCode][N>=13,SecCode]\nda_all_m <- da_all_m[SecCode %in% selectedcode,]\n# Method 2 # use dplyr to slove the same problem\nda_all_m <- da_all_m %>% group_by(SecCode) %>% filter(n()>=13)\nda_all_m <- as.data.table(da_all_m)\n\nda_all_m[,`:=`(ret_0_12=rollsum(ret,13,align=\"right\",fill=NA),\n               ret_0_1=rollsum(ret,2,align=\"right\",fill=NA)),by=SecCode]\nda_all_m[,ret_mom := ret_0_12-ret_0_1]\nda_all_m[ret_mom<=quantile(ret_mom,0.3,na.rm=T),group_mom := \"d\",by=ym]\nda_all_m[ret_mom>quantile(ret_mom,0.3,na.rm=T) & ret_mom<=quantile(ret_mom,0.7,na.rm=T),\n         group_mom := \"m\",by=ym]\nda_all_m[ret_mom>quantile(ret_mom,0.7,na.rm=T),group_mom := \"u\",by=ym]\n\nFFC4F <- da_all_m[,.(ym=sort(unique(ym)))]\nFFC4F$smb <- da_all_m[group_size==\"s\",weighted.mean(ret,size),keyby=ym][[2]]-\n  da_all_m[group_size==\"b\",weighted.mean(ret,size),keyby=ym][[2]]\nFFC4F$hml <- (da_all_m[group_size==\"b\" & group_BM==\"h\",weighted.mean(ret,size),keyby=ym][[2]]-\n               da_all_m[group_size==\"b\" & group_BM==\"l\",weighted.mean(ret,size),keyby=ym][[2]])/2+\n  ((da_all_m[group_size==\"s\" & group_BM==\"h\",weighted.mean(ret,size),keyby=ym][[2]]-\n      da_all_m[group_size==\"s\" & group_BM==\"l\",weighted.mean(ret,size),keyby=ym][[2]]))/2\nFFC4F$umd <- c(rep(NA,12),da_all_m[group_mom==\"u\",mean(ret),keyby=ym][[2]]-\n  da_all_m[group_mom==\"d\",mean(ret),keyby=ym][[2]])\n\nFFC4F$mkt <- da_all_m[,weighted.mean(ret_e,size),keyby=ym][,2]\nsave(FFC4F,file=\"C:/Users/Ding/Desktop/FFC4F.RData\")\n\n#################################\n#### 25 Fama-French Portfolios\nload(\"D:/厦门大学研究生/量化投资（赵华）/作业/HW3/RData/da_all_m_a.RData\")\nload(\"D:/厦门大学研究生/量化投资（赵华）/作业/HW3/RData/FFC4F.RData\")\n\nda_all_m[size<=quantile(size,0.2),group_size := 1,by=ym]\nda_all_m[size>quantile(size,0.2) & size<=quantile(size,0.4),group_size := 2,by=ym]\nda_all_m[size>quantile(size,0.4) & size<=quantile(size,0.6),group_size := 3,by=ym]\nda_all_m[size>quantile(size,0.6) & size<=quantile(size,0.8),group_size := 4,by=ym]\nda_all_m[size>quantile(size,0.8),group_size := 5,by=ym]\n\nda_all_m[BM<=quantile(BM,0.2),group_BM := 1,by=ym]\nda_all_m[BM>quantile(BM,0.2) & BM<=quantile(BM,0.4),group_BM := 2,by=ym]\nda_all_m[BM>quantile(BM,0.4) & BM<=quantile(BM,0.6),group_BM := 3,by=ym]\nda_all_m[BM>quantile(BM,0.6) & BM<=quantile(BM,0.8),group_BM := 4,by=ym]\nda_all_m[BM>quantile(BM,0.8),group_BM := 5,by=ym]\n\nret_p <- array(NA,c(5,5,nrow(FFC4F)))\nnow()\nfor (i in 1:5) {\n  for (j in 1:5) {\n    for (k in 1:nrow(FFC4F)) {\n      ret_p[i,j,k] <- da_all_m[group_size==i & group_BM==j & ym==FFC4F[k,ym],weighted.mean(ret_e,size)]\n    }\n  }\n}\nnow()\n\nmodel_4_er <- matrix(NA,nrow=5,ncol=5)\nmodel_4_alpha <- matrix(NA,nrow=5,ncol=5)\nmodel_4_alpha_t <- matrix(NA,nrow=5,ncol=5) # Newey-West t statistics\nmodel_4_mkt <- matrix(NA,nrow=5,ncol=5)\nmodel_4_smb <- matrix(NA,nrow=5,ncol=5)\nmodel_4_hml <- matrix(NA,nrow=5,ncol=5)\nmodel_4_umd <- matrix(NA,nrow=5,ncol=5)\nmodel_4_r2 <- matrix(NA,nrow=5,ncol=5)\nmodel_4_adj_r2 <- matrix(NA,nrow=5,ncol=5)\n\nfor (i in 1:5) {\n  for (j in 1:5) {\n    model_4_er[i,j] <- mean(ret_p[i,j,],na.rm=T)\n    model <- lm(ret_p[i,j,]~FFC4F[,mkt]+FFC4F[,smb]+FFC4F[,hml]+FFC4F[,umd])\n    model_4_alpha[i,j] <- summary(model)$coefficients[1,1]\n    model_4_alpha_t[i,j] <- coeftest(model,vcov = NeweyWest(model))[1,3]\n    model_4_mkt[i,j] <- summary(model)$coefficients[2,1]\n    model_4_smb[i,j] <- summary(model)$coefficients[3,1]\n    model_4_hml[i,j] <- summary(model)$coefficients[4,1]\n    model_4_umd[i,j] <- summary(model)$coefficients[5,1]\n    model_4_r2[i,j] <- summary(model)$r.squared\n    model_4_adj_r2[i,j] <- summary(model)$adj.r.squared\n  }\n}\n",
    "created" : 1510242286353.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "1957293619",
    "id" : "1F5CF5C2",
    "lastKnownWriteTime" : 1512927930,
    "last_content_update" : 1512927930726,
    "path" : "C:/Users/heyouxin/Desktop/HW3.R",
    "project_path" : null,
    "properties" : {
    },
    "relative_order" : 5,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}